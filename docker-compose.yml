services:
  wyoming-whisper:
    build:
      context: ./whisper
      dockerfile: Dockerfile
      args:
        HSA_OVERRIDE_GFX_VERSION: ${HSA_OVERRIDE_GFX_VERSION:-11.5.1}
        # Build for multiple GPU architectures (RDNA 2 and RDNA 3)
        AMDGPU_TARGETS: gfx1151
        CMAKE_HIP_ARCHITECTURES: gfx1151
    container_name: wyoming-whisper-rocm
    restart: unless-stopped

    # GPU device access - required for ROCm
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri

    # Security options for GPU access
    security_opt:
      - seccomp:unconfined

    # Group access for GPU
    group_add:
      - video
      - render

    # Environment variables
    environment:
      - HSA_OVERRIDE_GFX_VERSION=${HSA_OVERRIDE_GFX_VERSION:-11.5.1}
      - HIP_VISIBLE_DEVICES=0
      - ROCM_VERSION=7.1.1
      - ROCM_PATH=/opt/rocm
      - LD_LIBRARY_PATH=/usr/local/lib:/opt/rocm/lib:/opt/rocm/lib/llvm/lib
      - CTRANSLATE2_ROOT=/usr/local
      # Whisper model configuration
      - WHISPER_MODEL=${WHISPER_MODEL:-medium}
      - WHISPER_COMPUTE_TYPE=${WHISPER_COMPUTE_TYPE:-float16}
      - WHISPER_BEAM_SIZE=${WHISPER_BEAM_SIZE:-5}
      - WHISPER_DEBUG=${WHISPER_DEBUG:-false}

    # Port for Wyoming protocol
    ports:
      - "10300:10300"

    # Volume for model persistence
    volumes:
      - ./data:/data

    # Health check
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.connect(('localhost',10300)); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # wyoming-piper: (Commented out - migrated to Qwen3-TTS)
  # wyoming-piper:
  #   build:
  #     context: ./piper
  #     dockerfile: Dockerfile
  #     args:
  #       HSA_OVERRIDE_GFX_VERSION: ${HSA_OVERRIDE_GFX_VERSION:-11.5.1}
  #       # Build for multiple GPU architectures (RDNA 2 and RDNA 3)
  #       AMDGPU_TARGETS: gfx1151
  #   container_name: wyoming-piper-rocm
  #   restart: unless-stopped
  #
  #   # GPU device access - required for ROCm
  #   devices:
  #     - /dev/kfd:/dev/kfd
  #     - /dev/dri:/dev/dri
  #
  #   # Security options for GPU access
  #   security_opt:
  #     - seccomp:unconfined
  #
  #   # Group access for GPU
  #   group_add:
  #     - video
  #     - render
  #
  #   # Environment variables
  #   environment:
  #     - HSA_OVERRIDE_GFX_VERSION=${HSA_OVERRIDE_GFX_VERSION:-11.5.1}
  #     - HIP_VISIBLE_DEVICES=0
  #     - ROCM_VERSION=7.1.1
  #     - ROCM_PATH=/opt/rocm
  #     - LD_LIBRARY_PATH=/usr/local/lib:/opt/rocm/lib:/opt/rocm/lib/llvm/lib
  #     # ONNX Runtime threading - configured dynamically by piper_wrapper.py
  #     # Piper voice configuration
  #     - PIPER_VOICE=${PIPER_VOICE:-en_US-lessac-medium}
  #     - PIPER_LENGTH_SCALE=${PIPER_LENGTH_SCALE:-1.0}
  #     - PIPER_NOISE_SCALE=${PIPER_NOISE_SCALE:-0.667}
  #     - PIPER_NOISE_W=${PIPER_NOISE_W:-0.8}
  #     - PIPER_DEBUG=${PIPER_DEBUG:-false}
  #
  #   # Port for Wyoming protocol
  #   ports:
  #     - "10200:10200"
  #
  #   # Volume for model persistence
  #   volumes:
  #     - ./piper-data:/data
  #
  #   # Health check
  #   healthcheck:
  #     test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.connect(('localhost',10200)); s.close()"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 60s

  wyoming-qwen-tts:
    build:
      context: ./qwen3-tts
      dockerfile: Dockerfile
      args:
        HSA_OVERRIDE_GFX_VERSION: ${HSA_OVERRIDE_GFX_VERSION:-11.5.1}
    container_name: wyoming-qwen-tts-rocm
    restart: unless-stopped

    # GPU device access - required for ROCm
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri

    # Security options for GPU access
    security_opt:
      - seccomp:unconfined

    # Group access for GPU
    group_add:
      - video
      - render

    # Environment variables
    environment:
      - HSA_OVERRIDE_GFX_VERSION=${HSA_OVERRIDE_GFX_VERSION:-11.5.1}
      - HIP_VISIBLE_DEVICES=0
      - ROCM_VERSION=7.1.1
      - ROCM_PATH=/opt/rocm
      - LD_LIBRARY_PATH=/usr/local/lib:/opt/rocm/lib:/opt/rocm/lib/llvm/lib
      # Enable experimental ROCm SDPA optimizations for better performance
      - TORCH_ROCM_AOTRITON_ENABLE_EXPERIMENTAL=1
      # MIOpen performance tuning - fix workspace allocation warnings
      - MIOPEN_USER_DB_PATH=/tmp/miopen-cache
      - MIOPEN_CUSTOM_CACHE_DIR=/tmp/miopen-cache
      - MIOPEN_FIND_MODE=1
      # PyTorch memory optimization
      - PYTORCH_HIP_ALLOC_CONF=expandable_segments:True
      # Hugging Face cache configuration
      - HF_HOME=/data/hf_cache
      - TRANSFORMERS_CACHE=/data/hf_cache
      - HUGGINGFACE_HUB_CACHE=/data/hf_cache/hub
      # Qwen3-TTS configuration
      - QWEN_MODEL=${QWEN_MODEL:-Qwen/Qwen3-TTS-12Hz-1.7B-VoiceDesign}
      - QWEN_VOICE_INSTRUCT=${QWEN_VOICE_INSTRUCT:-Clear, natural voice with medium pitch. Friendly British female personal assistant.}
      - QWEN_LANGUAGE=${QWEN_LANGUAGE:-Auto}
      - QWEN_DEVICE=${QWEN_DEVICE:-cuda:0}
      - QWEN_DTYPE=${QWEN_DTYPE:-bfloat16}
      - QWEN_FLASH_ATTENTION=${QWEN_FLASH_ATTENTION:-true}
      - QWEN_SAMPLES_PER_CHUNK=${QWEN_SAMPLES_PER_CHUNK:-1024}
      - QWEN_CACHE_DIR=/data/models
      - QWEN_DEBUG=${QWEN_DEBUG:-true}

    # Port for Wyoming protocol
    ports:
      - "10200:10200"

    # Volume for model persistence
    volumes:
      - ./qwen-data:/data

    # Health check
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.connect(('localhost',10200)); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  wyoming-chatterbox-turbo:
    build:
      context: ./chatterbox-turbo
      dockerfile: Dockerfile
      args:
        HSA_OVERRIDE_GFX_VERSION: ${HSA_OVERRIDE_GFX_VERSION:-11.5.1}
    container_name: wyoming-chatterbox-turbo-rocm
    restart: unless-stopped

    # GPU device access - required for ROCm
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri

    # Security options for GPU access
    security_opt:
      - seccomp:unconfined

    # Group access for GPU
    group_add:
      - video

    # Environment variables
    environment:
      - HSA_OVERRIDE_GFX_VERSION=${HSA_OVERRIDE_GFX_VERSION:-11.5.1}
      - HIP_VISIBLE_DEVICES=0
      - ROCM_VERSION=7.1.1
      - ROCM_PATH=/opt/rocm
      - LD_LIBRARY_PATH=/usr/local/lib:/opt/rocm/lib:/opt/rocm/lib/llvm/lib
      # Enable experimental ROCm SDPA optimizations for better performance
      - TORCH_ROCM_AOTRITON_ENABLE_EXPERIMENTAL=1
      # MIOpen performance tuning - fix workspace allocation warnings
      - MIOPEN_USER_DB_PATH=/tmp/miopen-cache
      - MIOPEN_CUSTOM_CACHE_DIR=/tmp/miopen-cache
      - MIOPEN_FIND_MODE=1
      # Hugging Face cache configuration
      - HF_HOME=/data/hf_cache
      - TRANSFORMERS_CACHE=/data/hf_cache
      - HUGGINGFACE_HUB_CACHE=/data/hf_cache/hub
      - HF_TOKEN=${HF_TOKEN}
      # Chatterbox Turbo configuration
      - CHATTERBOX_DEVICE=${CHATTERBOX_DEVICE:-cuda:0}
      - CHATTERBOX_SAMPLES_PER_CHUNK=${CHATTERBOX_SAMPLES_PER_CHUNK:-1024}
      - CHATTERBOX_CACHE_DIR=/data/models
      - CHATTERBOX_DEBUG=${CHATTERBOX_DEBUG:-true}

    # Port for Wyoming protocol (using 10201 to avoid conflict with qwen)
    ports:
      - "10201:10200"

    # Volume for model persistence
    volumes:
      - ./chatterbox-data:/data

    # Health check
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.connect(('localhost',10200)); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  wyoming-pocket-tts:
    build:
      context: ./pocket-tts
      dockerfile: Dockerfile
      args:
        HSA_OVERRIDE_GFX_VERSION: ${HSA_OVERRIDE_GFX_VERSION:-11.5.1}
    container_name: wyoming-pocket-tts-rocm
    restart: unless-stopped

    # GPU device access - required for ROCm base image
    # Note: Pocket TTS is CPU-only and doesn't benefit from GPU
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri

    # Security options for GPU access
    security_opt:
      - seccomp:unconfined

    # Group access for GPU
    group_add:
      - video
      - render

    # Environment variables
    environment:
      - HSA_OVERRIDE_GFX_VERSION=${HSA_OVERRIDE_GFX_VERSION:-11.5.1}
      - ROCM_VERSION=7.1.1
      - ROCM_PATH=/opt/rocm
      - LD_LIBRARY_PATH=/usr/local/lib:/opt/rocm/lib:/opt/rocm/lib/llvm/lib
      # Hugging Face cache configuration
      - HF_HOME=/data/hf_cache
      - TRANSFORMERS_CACHE=/data/hf_cache
      - HUGGINGFACE_HUB_CACHE=/data/hf_cache/hub
      # Pocket TTS configuration
      # Built-in voices: alba, marius, javert, jean, fantine, cosette, eponine, azelma
      # For voice cloning, use HF URLs or .wav file paths (requires gated model access)
      - POCKET_VOICE=${POCKET_VOICE:-fantine}
      - POCKET_CACHE_DIR=/data/models
      - POCKET_DEBUG=${POCKET_DEBUG:-true}

    # Port for Wyoming protocol (using 10202 to avoid conflicts)
    ports:
      - "10202:10202"

    # Volume for model persistence
    volumes:
      - ./pocket-data:/data

    # Health check
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.connect(('localhost',10202)); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
